\documentclass[a4paper]{article}

\usepackage{amsmath}
\usepackage{amssymb,amsfonts}
\usepackage[catalan]{babel} % Language 
\usepackage{fontspec} % <-- AQUESTA LINEA EM PETA (RAUL)
\usepackage[margin=2cm]{geometry}
\usepackage{graphicx}
\usepackage[makeroom]{cancel}
\usepackage{listings}
\usepackage[dvipsnames]{xcolor}

\setlength{\parindent}{0pt}
\setlength{\parskip}{0.2cm}

\lstset{ % Donat que el paquest listings no té la sintaxi per R definida la hem de definir nosaltres
    language=R,                     % the language of the code
    basicstyle=\ttfamily\footnotesize,       % the size of the fonts that are used for the code
    numbers=left,                   % where to put the line-numbers
    numberstyle=\tiny\color{gray},  % the style that is used for the line-numbers
    stepnumber=1,                   % the step between two line-numbers. If it's 1, each line
    % will be numbered
    numbersep=5pt,                  % how far the line-numbers are from the code
    backgroundcolor=\color{white},  % choose the background color. You must add \usepackage{color}
    showspaces=false,               % show spaces adding particular underscores
    showstringspaces=false,         % underline spaces within strings
    showtabs=false,                 % show tabs within strings adding particular underscores
    frame=single,                   % adds a frame around the code
    rulecolor=\color{black},        % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. commens (green here))
    tabsize=2,                      % sets default tabsize to 2 spaces
    captionpos=b,                   % sets the caption-position to bottom
    breaklines=true,                % sets automatic line breaking
    breakatwhitespace=false,        % sets if automatic breaks should only happen at whitespace
    title=\lstname,                 % show the filename of files included with \lstinputlisting;
    % also try caption instead of title
    keywordstyle=\color{blue},      % keyword style
    commentstyle=\color{OliveGreen},   % comment style
    stringstyle=\color{purple},      % string literal style
    escapeinside={\%*}{*)},         % if you want to add a comment within your code
    morekeywords={*,...}            % if you want to add more keywords to the set
} 


\title{\textsc{APA Problemes} \\ Problema 3 Màxima versemblança}
\author{Lluc Bové \and Raúl Ibàñez \and Joan Marcè \and Aleix Trassera}
\date{}

\begin{document}

\maketitle

\textbf{Considerem un experiment aleatori en què mesurem una determinada variable aleatòria $X$, que segueix una distribució gaussiana, cosa que escrivim $X \sim N(\mu, \sigma^2)$. Prenem $N$ mesures independents de $X$ i obtenim una mostra aleatòria simple $\{x_1, ..., x_N\}$ on cada $x_n$ és una realització de $X$, per $n=1,...,N$. Es demana:}

\begin{enumerate}
\item \textbf{Escriviu la funció de densitat de probabilitat per un $x_n$ qualsevol i construïu la funció log-versemblança (negativa) de la mostra.}

$$p(x_n, \sigma^2, \mu) = \frac{1}{\sqrt{2\pi\sigma}} exp\left(-\frac{(x_n - \mu)^2}{2\sigma^2}\right)$$

$$ -l(\theta) = -l(\mu,\sigma^2) = -\sum_{n=1}^2N ln(p(x_n, \mu, \sigma^2)) = - \sum_{n=1}^N ln \left\{\frac{1}{\sqrt{2\pi\sigma}} exp\left(-\frac{(x_n - \mu)^2}{2\sigma^2}\right) \right\}$$

\item \textbf{Trobeu els estimadors de màxima versemblança $\hat{\mu}$ i $\hat{\sigma}^2$ per $\mu$ i per $\sigma^2$, a partir de la mostra.}

$$\text{Màximitzar} l(\theta) \leftrightarrow \text{Minimitzar} -l(\theta)$$

$$ \frac{\partial(-l)}{\partial\mu} = -\sum_{n=1}^N \frac{2(x_n - \mu)}{2\sigma^2} = 0 \implies 
\sum_{n=1}^N x_n - \mu = 0 \implies \sum_{n=1}^N x_n = N·\mu \implies \boxed{\hat{\mu} = \sum_{n=1}^N \frac{x_n}{N}}$$ 

$$
\frac{\partial(-l)}{\partial\sigma^2} = \frac{N}{2\sigma^2} - \frac{1}{2\sigma^4}\sum_{n=1}^N (x_n - \mu)^2 = 0 \longrightarrow
\begin{aligned}
\footnotesize
\text{Substituïm } \mu \text{ per}\\
\footnotesize
\hat{\mu} \text{ i aïllem } \sigma^2 
\end{aligned} 
\implies \boxed{\hat{\sigma}^2 = \frac{1}{N} \sum_{n=1}^N (x_n - \hat{\mu})^2} $$

\item \textbf{Demostreu que realment són màxims (i no extrems qualssevol).}

$$ \sigma^2 > 0 \implies \frac{\partial^2(-l)}{\partial^2\mu} > 0 \implies \hat{\mu} \text{ és mínim}$$

$$ \hat{\sigma}^2 = \frac{1}{N} \sum_{n=1}^N (x_n - \hat{\mu})^2 \rightarrow \hat{\sigma}^2 \text{ és dependent de } \hat{\mu}$$

\item \textbf{Calculeu els biaixos dels dos estimadors. Determineu si l'estimador per $\mu$ és consistent.}

$$ bias(\hat{\theta}) := \mathbb{E}(\hat{\theta}) - \theta \implies bias(\hat{\mu}) = \underbrace{\mathbb{E}(\hat{\mu})}_{\mu} - \mu = \mu - \mu = 0 $$

$$ \mathbb{E}(\hat{\mu}) = \mathbb{E}\underbrace{\left(\sum_{n=1}^N \frac{x_n}{N}\right)}_{\text{trobat abans}} = \frac{1}{N}\sum_{n=1}^N \mathbb{E}(x_n) = \frac{1}{N}\sum_{n=1}^N \mu = \frac{\cancel{N}}{\cancel{N}}\mu = \mu$$

% Falta afegir el càlcul del vias de sigma^2

\item \textbf{Calculeu la variança de l'estimador per $\mu$, de 3 maneres (que han de coincidir). Pista: useu que si $X_n, X_m \sim N(\mu, \sigma^2)$, llavors:}

$$ \mathbb{E}[X_n · X_m] = 
\begin{cases}
\mu^2 & \text{ si } n \ne m \\
\mu^2 + \sigma^2 & \text{ si } n = m
\end{cases}$$

\begin{enumerate}
    \item Inserint directament el valor de l'estimador i utilitzant les propietats de la variància.
    
    $$ Var(\hat{\mu}) = Var\left(\frac{1}{N} \sum_{n=1}^{N}(x_n)\right) = \frac{1}{N^2} \sum_{n=1}^{N}Var(x_n) = \frac{1}{N^{\cancel{2}}}\cancel{N}\sigma^2 = \boxed{\frac{\sigma^2}{N}}    $$
    
    \item Usant la coneguda fórmula $Var[\hat{\theta}] = \mathbb{E}[\hat{\theta}^2] - (\mathbb{E}[\hat{\theta}])^2$.
    
    $$ \mathbb{E}[\hat{\mu}^2]  = \mathbb{E}\left[\left(\frac{1}{N^2}\sum_{n=1}^{N}x_n\right)^2\right] =
    \mathbb{E}\left[\frac{1}{N^2} \left(\sum_{n=1}^{N}x_n\right)\left(\sum_{m=1}^{M}x_m\right)\right] = \frac{1}{N^2}\sum_{n=1}^{N}\sum_{m=1}^{M}\mathbb{E}[x_n x_m] = $$
    $$ = \frac{1}{N^2}\left(N(\mu^2+\sigma^2)+(N^2-N)\mu^2\right) = \frac{\cancel{\mu^2}+\sigma^2}{N}+\mu^2-\cancel{\frac{\mu^2}{N}} = \frac{\sigma^2}{N}+\mu^2 $$
    
    $$ (\mathbb{E}[\hat{\mu}])^2 = \left(\mathbb{E}\left[\frac{1}{N}\sum_{n=1}^{N}x_n\right]\right)^2 = \left(\frac{1}{N}\sum_{n=1}^{N}\mu\right)^2 = \left(\frac{1}{\cancel{N}} \cancel{N} \mu\right)^2 = \mu^2 $$
    
    $$ \implies  \mathbb{E}[\hat{\theta}^2] - (\mathbb{E}[\hat{\theta}])^2  = \frac{\sigma^2}{N}+\cancel{\mu^2} - \cancel{\mu^2} = \boxed{\frac{\sigma^2}{N}} $$
    
    \item Utilitzant la definició de la variància $Var[\hat{\theta}] = \mathbb{E}[(\mathbb{E}[\hat{\theta}] - \hat{\theta})^2]$.
    
    $$ \mathbb{E}[(\mathbb{E}[\hat{\mu}]-\hat{\mu})^2] = \mathbb{E}[(\mu-\frac{1}{N}\sum_{n=1}^{N}x_n)^2] = \mathbb{E}(\mu-\frac{1}{N}\sum_{n=1}^{N}x_n)(\mu-\frac{1}{N}\sum_{n=1}^{N}x_n) = $$    
\end{enumerate}

\item \textbf{Per determinar la velocitat màxima d'un prototip d'avió es van fer 15 proves (caríssimes) amb els resultats 422.2, 418.7, 425.6, 420.3, 425.8, 423.1, 431.5, 428.2, 438.3, 434.0, 411.3, 417.2, 413.5, 441.3, 423.0, expressats en $m/s$. Suposant que aquesta velocitat màxima és gaussiana, quins valors estimaríeu per $\mu$ i per $\sigma$?}

\item \textbf{\emph{[R]} Fixeu unes $ \mu $ i $ \sigma^2 $ al vostre gust i genereu 1.000 mostres aleatòries simples Gaussianes de mida $ N = 50 $ (noteu que no cal emmagatzemar-les); utilitzeu les mostres (que han de ser m.a.s. i independents entre sí) per estimar els biaixos i variàncies dels valors teòrics $ \mu $ i $ \sigma^2 $. Compareu els resultats respecte els valors teòrics dels estimadors.}

En el següent script s'inclou el codi per solucionar el problema. Es creen 1000 conjunts de mida 50 i es calcula $ bias(\mu), bias(\sigma^2), Var(\mu)\text{ i } Var(\sigma^2)$.

\lstinputlisting[language=R]{L1_problemes.R}

\end{enumerate}

\end{document}